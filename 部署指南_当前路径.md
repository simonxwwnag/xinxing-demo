# 部署指南 - 项目在 /root/xinxing_demo/

## 当前状态
- ✅ 项目已上传到: `/root/xinxing_demo/`
- ⏳ 需要完成: 部署配置和环境变量设置
- ⏳ 证书文件: 待上传

## 步骤1: SSH登录服务器

```bash
ssh root@124.220.51.21
```

## 步骤2: 进入项目目录并执行部署

```bash
cd /root/xinxing_demo
chmod +x deploy.sh

# 修改部署脚本中的路径（从/var/www改为/root）
# 或者直接修改部署脚本
sed -i 's|/var/www/xinxing_demo|/root/xinxing_demo|g' deploy.sh

# 执行部署
./deploy.sh
```

**注意**: 如果部署脚本中的路径是 `/var/www/xinxing_demo`，需要修改为 `/root/xinxing_demo`。

## 步骤3: 手动修改部署脚本路径（如果需要）

如果部署脚本执行失败，手动修改：

```bash
cd /root/xinxing_demo
nano deploy.sh
```

查找所有 `/var/www/xinxing_demo` 并替换为 `/root/xinxing_demo`，然后保存。

## 步骤4: 配置环境变量

```bash
cd /root/xinxing_demo/backend

# 创建.env文件
nano .env
```

填入以下内容（替换为您的实际值）：

```env
# 火山引擎知识库配置
VIKING_AK=你的实际AK
VIKING_SK=你的实际SK
VIKING_HOST=api-knowledgebase.mlp.cn-beijing.volces.com

# 阿里云百炼配置
DASHSCOPE_API_KEY=你的实际API密钥

# 知识库集合和文档ID
KNOWLEDGE_COLLECTION_ID=你的集合ID
GROUP_SUPPLIER_DOC_ID=你的文档ID
OILFIELD_SUPPLIER_DOC_ID=你的文档ID

# 证书文件目录（使用默认路径）
# CERTIFICATE_DIR=/root/xinxing_demo/certificates
```

保存后（Ctrl+O, Enter, Ctrl+X）：

```bash
chmod 600 .env
```

## 步骤5: 创建证书文件目录并上传证书

### 5.1 在服务器上创建证书目录

```bash
mkdir -p /root/xinxing_demo/certificates
chmod 755 /root/xinxing_demo/certificates
```

### 5.2 从本地上传证书文件

**在本地终端执行**（不要SSH登录）：

```bash
# 上传整个证书目录
scp -r "/Users/simon/Downloads/部分人员证书"/* root@124.220.51.21:/root/xinxing_demo/certificates/
```

或者如果证书目录名称不同，替换为实际路径：

```bash
scp -r "/您的证书目录路径"/* root@124.220.51.21:/root/xinxing_demo/certificates/
```

**注意**: 
- 会提示输入服务器密码
- `/*` 表示上传目录内的所有文件，不包括目录本身
- 如果证书目录中有子目录，使用 `-r` 递归上传

### 5.3 验证证书文件已上传

```bash
# SSH登录服务器
ssh root@124.220.51.21

# 查看证书文件
ls -la /root/xinxing_demo/certificates/
```

## 步骤6: 修改Nginx配置（如果使用Nginx）

如果部署脚本配置了Nginx，需要修改Nginx配置中的路径：

```bash
nano /etc/nginx/sites-available/xinxing_demo
```

或者如果使用sites-enabled：

```bash
nano /etc/nginx/sites-enabled/xinxing_demo
```

将所有 `/var/www/xinxing_demo` 替换为 `/root/xinxing_demo`，然后：

```bash
nginx -t  # 测试配置
systemctl restart nginx
```

## 步骤7: 修改Systemd服务配置（如果使用）

如果部署脚本创建了systemd服务，需要修改服务文件：

```bash
nano /etc/systemd/system/xinxing-backend.service
```

将所有 `/var/www/xinxing_demo` 替换为 `/root/xinxing_demo`，然后：

```bash
systemctl daemon-reload
systemctl restart xinxing-backend
```

## 步骤8: 启动服务

### 方式A: 使用Systemd（如果已配置）

```bash
systemctl start xinxing-backend
systemctl status xinxing-backend
```

### 方式B: 手动启动（如果没有配置Systemd）

```bash
cd /root/xinxing_demo/backend
source venv/bin/activate
python main.py
```

或者使用screen/tmux在后台运行：

```bash
# 安装screen（如果没有）
apt-get install -y screen  # Ubuntu/Debian
# 或
yum install -y screen  # CentOS

# 启动screen会话
screen -S xinxing

# 在screen中启动服务
cd /root/xinxing_demo/backend
source venv/bin/activate
python main.py

# 按 Ctrl+A 然后 D 退出screen（服务继续运行）
```

## 步骤9: 验证部署

访问以下地址：
- 前端: http://124.220.51.21:3000 (如果前端单独运行)
- 后端API: http://124.220.51.21:8000
- API文档: http://124.220.51.21:8000/docs
- 健康检查: http://124.220.51.21:8000/health

## 证书文件说明

证书文件应该放在：
```
/root/xinxing_demo/certificates/
```

这个目录会在部署时自动创建，或者您可以手动创建。证书文件可以是：
- PDF文件
- 图片文件（jpg, png等）
- 其他格式的证书文件

文件名应该包含人员姓名，系统会根据姓名自动匹配证书文件。

## 常见问题

### Q1: 如何查看服务是否运行？

```bash
# 检查端口是否监听
netstat -tlnp | grep 8000

# 或使用ss命令
ss -tlnp | grep 8000
```

### Q2: 如何查看日志？

```bash
# 如果使用systemd
journalctl -u xinxing-backend -f

# 或查看日志文件
tail -f /root/xinxing_demo/logs/backend.log
```

### Q3: 如何重启服务？

```bash
# 如果使用systemd
systemctl restart xinxing-backend

# 如果手动运行，需要找到进程并重启
ps aux | grep "python main.py"
kill <进程ID>
# 然后重新启动
```

### Q4: 证书文件上传失败？

检查：
1. 证书目录路径是否正确
2. 服务器磁盘空间是否足够
3. 文件权限是否正确

```bash
# 检查磁盘空间
df -h

# 检查目录权限
ls -la /root/xinxing_demo/certificates/
```

